[["index.html", "R code for causal inference book Preface", " R code for causal inference book Duzhe Wang 2020-12-21 Preface The R code is based on the code by Joy Shi and Sean McGrath given here, and the rendered version by Tom Palmer given here. "],["why-model.html", "11. Why model? Some concepts and points Program 11.1 Program 11.2 Program 11.3", " 11. Why model? Some concepts and points Estimand Estimator We can not always let the data “speak for themselves” to obtain a meaningful estimate. Rather, we often need to supplement the data with a model. What is a model? A model is defined by an a priori restriction on the joint distribution of the data. When using a parametric model, the inferences are correct only if the restrictions encoded in the model are correct, i.e., if the model is correctly specified. Thus model-based causal inference relies on conditions of no model misspecification. Fisher consistency: An estimator of a population quantity that, when calculated using the entire population rather than a sample, yields the true value of the population parameter. Bias-variance trade-off Program 11.1 Sample averages by treatment level Data from Figures 11.1 and 11.2 A&lt;-c(rep(1, 8), rep(0, 8)) Y &lt;- c(200, 150, 220, 110, 50, 180, 90, 170, 170, 30, 70, 110, 80, 50, 10, 20) plot(A, Y, pch=16) mean(Y[A == 0]) ## [1] 67.5 mean(Y[A == 1]) ## [1] 146.25 A2&lt;-c(rep(1,4), rep(2, 4), rep(3, 4), rep(4,4)) Y2 &lt;- c(110, 80, 50, 40, 170, 30, 70, 50, 110, 50, 180, 130, 200, 150, 220, 210) plot(A2, Y2, pch=16) mean(Y2[A2 == 1]) ## [1] 70 mean(Y2[A2 == 2]) ## [1] 80 mean(Y2[A2 == 3]) ## [1] 117.5 mean(Y2[A2 == 4]) ## [1] 195 Program 11.2 2-parameter linear model Data from Figures 11.3 and 11.1 A3 &lt;-c(3, 11, 17, 23, 29, 37, 41, 53, 67, 79, 83, 97, 60, 71, 15, 45) Y3 &lt;-c(21, 54, 33, 101, 85, 65, 157, 120, 111, 200, 140, 220, 230, 217, 11, 190) plot(Y3 ~ A3, pch=16) summary(glm(Y3 ~ A3)) ## ## Call: ## glm(formula = Y3 ~ A3) ## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -61.930 -30.564 -5.741 30.653 77.225 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 24.5464 21.3300 1.151 0.269094 ## A3 2.1372 0.3997 5.347 0.000103 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## (Dispersion parameter for gaussian family taken to be 1944.109) ## ## Null deviance: 82800 on 15 degrees of freedom ## Residual deviance: 27218 on 14 degrees of freedom ## AIC: 170.43 ## ## Number of Fisher Scoring iterations: 2 predict(glm(Y3 ~ A3), data.frame(A3 = 90)) ## 1 ## 216.89 summary(glm(Y ~ A)) ## ## Call: ## glm(formula = Y ~ A) ## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -96.250 -40.000 3.125 35.938 102.500 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 67.50 19.72 3.424 0.00412 ** ## A 78.75 27.88 2.824 0.01352 * ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## (Dispersion parameter for gaussian family taken to be 3109.821) ## ## Null deviance: 68344 on 15 degrees of freedom ## Residual deviance: 43538 on 14 degrees of freedom ## AIC: 177.95 ## ## Number of Fisher Scoring iterations: 2 Program 11.3 3-parameter linear model: \\(E(Y|A)=\\theta_0+\\theta_{1}A+\\theta_{2}A^2\\), where \\(A^2=A\\times A\\) Data from Figure 11.3 Asq &lt;- A3 * A3 mod3 &lt;- glm(Y3 ~ A3 + Asq) summary(mod3) ## ## Call: ## glm(formula = Y3 ~ A3 + Asq) ## ## Deviance Residuals: ## Min 1Q Median 3Q Max ## -65.27 -34.41 13.21 26.11 64.36 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -7.40688 31.74777 -0.233 0.8192 ## A3 4.10723 1.53088 2.683 0.0188 * ## Asq -0.02038 0.01532 -1.331 0.2062 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## (Dispersion parameter for gaussian family taken to be 1842.697) ## ## Null deviance: 82800 on 15 degrees of freedom ## Residual deviance: 23955 on 13 degrees of freedom ## AIC: 170.39 ## ## Number of Fisher Scoring iterations: 2 predict(mod3, data.frame(cbind(A3 = 90, Asq = 8100))) ## 1 ## 197.1269 "],["ip-weighting-and-marginal-structural-models.html", "12. IP weighting and marginal structural models Concepts and points Estimating IP weights via modeling Real data analysis", " 12. IP weighting and marginal structural models Concepts and points Confounder Estimating IP weights via modeling Definition An individual’s IP weight depends on her values of treatment \\(A\\) and covariate \\(L\\). Since the denominator of the weight for each individual is the conditional density evaluated at the individual’s own values of \\(A\\) and \\(L\\), it can be expressed as the conditional density evaluated at the random arguments \\(A\\) and \\(L\\), that is, as \\(f(A|L)\\). Therefore, we write the IP weights as \\(1/f(A|L)\\). Potential outcome mean for treatment level \\(A=a\\): \\(E(Y^{a})\\) Standardized mean for treatment level \\(A=a\\): \\(\\sum_{l}E(Y|A=a, L=l)P(L=l)\\) IP weighted mean of \\(Y\\) for treatment level \\(A=a\\): \\(E\\left(\\frac{I(A=a)Y}{f(A|L)}\\right)\\) Equivalence of IP weighting and standardization Under the positivity assumption, we have \\[\\begin{equation*} \\begin{split} E\\left(\\frac{I(A=a)Y}{f(A|L)}\\right)=E_{A, L}\\left( E_{Y}(\\frac{I(A=a)}{f(A|L)}Y|A, L)\\right)=E_{A, L}\\left( E_{Y}(Y|A, L)\\frac{I(A=a)}{f(A|L)}\\right) \\\\ = E_{L}\\left(E_{A}\\left( E_{Y}(Y|A, L)\\frac{I(A=a)}{f(A|L)}|L\\right)\\right)=E_{L}\\left( E_{Y}(Y|A=a, L)|L\\right) \\\\ =\\sum_{l}E(Y|A=a, L=l)P(L=l) \\end{split} \\end{equation*}\\] Equivalence of potential outcome mean, standardized mean and IP weighted mean First, we show \\(E(Y^a)=\\sum_{l}E(Y|A=a, L=l)P(L=l)\\) under conditional exchangeability, positivity, and consistency. \\[\\begin{equation*} \\begin{split} E(Y^{a})=\\sum_{l}E(Y^a|L=l)P(L=l) \\\\ =\\sum_{l}E(Y^a|A=a, L=l)P(L=l)=\\sum_{l}E(Y|A=a, L=l)P(L=l), \\end{split} \\end{equation*}\\] where the second equality is by conditional exchangeability and positivity, and the third by consistency. Second, we show \\(E(Y^a)=E\\left( \\frac{I(A=a)}{f(A|L)}Y \\right)\\) under positivity, conditional exchangeability, and consistency. \\[\\begin{equation*} \\begin{split} E\\left(\\frac{I(A=a)}{f(A|L)}Y\\right)= E\\left( \\frac{I(A=a)}{f(A|L)}Y^a \\right)=E\\left( E\\left(\\frac{I(A=a)}{f(A|L)}Y^{a}|L\\right) \\right) \\\\ = E\\left(E\\left(\\frac{I(A=a)}{f(A|L)}|L\\right)E\\left(Y^a|L\\right) \\right)=E\\left(1\\times E\\left(Y^{a}|L\\right) \\right)=E(Y^a), \\end{split} \\end{equation*}\\] where the first equality is by consistency, the third by conditional exchangeability. Furthermore, we need positivity to well define the IP weights. Real data analysis Background NHEFS data (National Health and Nutrition Examination Survey Data I Epidemiologic Follow-up Study) Goal: estimate the effect of smoking cessation on weight gain \\(A=1\\): if cigarette smokers reported having quit smoking before the follow-up visit \\(Y\\): the body weight at the follow-up visit minus the body weight at the baseline visit \\(E(Y^{a=1})\\): mean weight gain that would have been observed if all individuals in the population had quit smoking before the follow-up visit \\(E(Y^{a=0})\\): mean weight gain that would have been observed if all individuals in the population had not quit smoking Average causal effect: \\(E(Y^{a=1})-E(Y^{a=0})\\) Program 12.1 library(here) # for path library(readxl) # for reafing excel files library(tidyverse) library(hrbrthemes) library(viridis) # copy from https://www.r-graph-gallery.com/89-box-and-scatter-plot-with-ggplot2.html Input dataset nhefs=read_excel(here(&quot;data&quot;, &quot;NHEFS.xls&quot;)) head(nhefs) ## # A tibble: 6 x 64 ## seqn qsmk death yrdth modth dadth sbp dbp sex age race income marital school education ht ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 233 0 0 NA NA NA 175 96 0 42 1 19 2 7 1 174. ## 2 235 0 0 NA NA NA 123 80 0 36 0 18 2 9 2 159. ## 3 244 0 0 NA NA NA 115 75 1 56 1 15 3 11 2 168. ## 4 245 0 1 85 2 14 148 78 0 68 1 15 3 5 1 170. ## 5 252 0 0 NA NA NA 118 77 0 40 0 18 2 11 2 182. ## 6 257 0 0 NA NA NA 141 83 1 43 1 11 4 9 2 162. ## # … with 48 more variables: wt71 &lt;dbl&gt;, wt82 &lt;dbl&gt;, wt82_71 &lt;dbl&gt;, birthplace &lt;dbl&gt;, smokeintensity &lt;dbl&gt;, ## # smkintensity82_71 &lt;dbl&gt;, smokeyrs &lt;dbl&gt;, asthma &lt;dbl&gt;, bronch &lt;dbl&gt;, tb &lt;dbl&gt;, hf &lt;dbl&gt;, hbp &lt;dbl&gt;, ## # pepticulcer &lt;dbl&gt;, colitis &lt;dbl&gt;, hepatitis &lt;dbl&gt;, chroniccough &lt;dbl&gt;, hayfever &lt;dbl&gt;, diabetes &lt;dbl&gt;, ## # polio &lt;dbl&gt;, tumor &lt;dbl&gt;, nervousbreak &lt;dbl&gt;, alcoholpy &lt;dbl&gt;, alcoholfreq &lt;dbl&gt;, alcoholtype &lt;dbl&gt;, ## # alcoholhowmuch &lt;dbl&gt;, pica &lt;dbl&gt;, headache &lt;dbl&gt;, otherpain &lt;dbl&gt;, weakheart &lt;dbl&gt;, allergies &lt;dbl&gt;, ## # nerves &lt;dbl&gt;, lackpep &lt;dbl&gt;, hbpmed &lt;dbl&gt;, boweltrouble &lt;dbl&gt;, wtloss &lt;dbl&gt;, infection &lt;dbl&gt;, ## # active &lt;dbl&gt;, exercise &lt;dbl&gt;, birthcontrol &lt;dbl&gt;, pregnancies &lt;dbl&gt;, cholesterol &lt;dbl&gt;, hightax82 &lt;dbl&gt;, ## # price71 &lt;dbl&gt;, price82 &lt;dbl&gt;, tax71 &lt;dbl&gt;, tax82 &lt;dbl&gt;, price71_82 &lt;dbl&gt;, tax71_82 &lt;dbl&gt; Ignore subjects with missing values for weight in 1982 wt82: weight in 1982 qsmk: quit smoking between 1st questionnaire and 1982 (Yes:1; No:0) nhefs.nmv=nhefs[which(!is.na(nhefs$wt82)), ] nhefs.nmv$qsmk=as.factor(nhefs.nmv$qsmk) Compare the treatment group and the control group age summary(nhefs.nmv[which(nhefs.nmv$qsmk==0), ]$age) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 25.00 33.00 42.00 42.79 51.00 72.00 summary(nhefs.nmv[which(nhefs.nmv$qsmk==1), ]$age) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 25.00 35.00 46.00 46.17 56.00 74.00 nhefs.nmv %&gt;% ggplot( aes(x=qsmk, y=age, fill=qsmk)) + geom_boxplot()+ scale_fill_viridis(discrete = TRUE, alpha=0.6) + geom_jitter(color=&quot;black&quot;, size=0.4, alpha=0.9) + theme_ipsum() + theme(legend.position=&quot;none&quot;, plot.title = element_text(size=11)) + ggtitle(&quot;Boxplot&quot;) + xlab(&quot;qsmk&quot;) wt71 summary(nhefs.nmv[which(nhefs.nmv$qsmk==0), ]$wt71) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 40.82 59.19 68.49 70.30 79.38 151.73 summary(nhefs.nmv[which(nhefs.nmv$qsmk==1), ]$wt71) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 39.58 60.67 71.21 72.35 81.08 136.98 nhefs.nmv %&gt;% ggplot( aes(x=qsmk, y=wt71, fill=qsmk)) + geom_boxplot()+ scale_fill_viridis(discrete = TRUE, alpha=0.6) + geom_jitter(color=&quot;black&quot;, size=0.4, alpha=0.9) + theme_ipsum() + theme(legend.position=&quot;none&quot;, plot.title = element_text(size=11)) + ggtitle(&quot;Boxplot&quot;) + xlab(&quot;qsmk&quot;) smokeintensity: number of cigarettes smoked per day in 1971 summary(nhefs.nmv[which(nhefs.nmv$qsmk==0), ]$smokeintensity) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.00 15.00 20.00 21.19 30.00 60.00 summary(nhefs.nmv[which(nhefs.nmv$qsmk==1), ]$smokeintensity) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.0 10.0 20.0 18.6 25.0 80.0 nhefs.nmv %&gt;% ggplot( aes(x=qsmk, y=smokeintensity, fill=qsmk)) + geom_boxplot()+ scale_fill_viridis(discrete = TRUE, alpha=0.6) + geom_jitter(color=&quot;black&quot;, size=0.4, alpha=0.9) + theme_ipsum() + theme(legend.position=&quot;none&quot;, plot.title = element_text(size=11)) + ggtitle(&quot;Boxplot&quot;) + xlab(&quot;qsmk&quot;) smokeyrs: years of smoking summary(nhefs.nmv[which(nhefs.nmv$qsmk==0), ]$smokeyrs) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.00 15.00 23.00 24.09 32.00 64.00 summary(nhefs.nmv[which(nhefs.nmv$qsmk==1), ]$smokeyrs) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 1.00 15.00 26.00 26.03 35.00 60.00 nhefs.nmv %&gt;% ggplot( aes(x=qsmk, y=smokeyrs, fill=qsmk)) + geom_boxplot()+ scale_fill_viridis(discrete = TRUE, alpha=0.6) + geom_jitter(color=&quot;black&quot;, size=0.4, alpha=0.9) + theme_ipsum() + theme(legend.position=&quot;none&quot;, plot.title = element_text(size=11)) + ggtitle(&quot;Boxplot&quot;) + xlab(&quot;qsmk&quot;) sex table(nhefs.nmv$qsmk, nhefs.nmv$sex) ## ## 0 1 ## 0 542 621 ## 1 220 183 prop.table(table(nhefs.nmv$qsmk, nhefs.nmv$sex), margin=1) # row-wise ## ## 0 1 ## 0 0.4660361 0.5339639 ## 1 0.5459057 0.4540943 nhefs.nmv$sex=as.factor(nhefs.nmv$sex) nhefs.nmv%&gt;%ggplot(aes(x = qsmk, fill = sex)) + geom_bar(position = &quot;dodge&quot;) race: 0 if white, 1 if black or other in 1971 table(nhefs.nmv$qsmk, nhefs.nmv$race) ## ## 0 1 ## 0 993 170 ## 1 367 36 prop.table(table(nhefs.nmv$qsmk, nhefs.nmv$race), margin=1) # row-wise ## ## 0 1 ## 0 0.85382631 0.14617369 ## 1 0.91066998 0.08933002 nhefs.nmv$race=as.factor(nhefs.nmv$race) nhefs.nmv%&gt;%ggplot(aes(x = qsmk, fill = race)) + geom_bar(position = &quot;dodge&quot;) education (AMOUNT OF EDUCATION BY 1971): 1 if 8TH GRADE OR LESS, 2 if HS DROPOUT, 3 if HS, 4 if COLLEGE DROPOUT, 5 if COLLEGE OR MORE table(nhefs.nmv$qsmk, nhefs.nmv$education) ## ## 1 2 3 4 5 ## 0 210 266 480 92 115 ## 1 81 74 157 29 62 prop.table(table(nhefs.nmv$qsmk, nhefs.nmv$education), margin=1) # row-wise ## ## 1 2 3 4 5 ## 0 0.18056750 0.22871883 0.41272571 0.07910576 0.09888220 ## 1 0.20099256 0.18362283 0.38957816 0.07196030 0.15384615 nhefs.nmv$education=as.factor(nhefs.nmv$education) nhefs.nmv%&gt;%ggplot(aes(x = qsmk, fill = education)) + geom_bar(position = &quot;dodge&quot;) exercise: 0 if much exercise,1 if moderate exercise,2 if little or no exercise table(nhefs.nmv$qsmk, nhefs.nmv$exercise) ## ## 0 1 2 ## 0 237 485 441 ## 1 63 176 164 prop.table(table(nhefs.nmv$qsmk, nhefs.nmv$exercise), margin=1) # row-wise ## ## 0 1 2 ## 0 0.2037833 0.4170249 0.3791917 ## 1 0.1563275 0.4367246 0.4069479 nhefs.nmv$exercise=as.factor(nhefs.nmv$exercise) nhefs.nmv%&gt;%ggplot(aes(x = qsmk, fill = exercise)) + geom_bar(position = &quot;dodge&quot;) active: 0 if very active, 1 if moderately active, 2 if inactive table(nhefs.nmv$qsmk, nhefs.nmv$active) ## ## 0 1 2 ## 0 532 527 104 ## 1 170 188 45 prop.table(table(nhefs.nmv$qsmk, nhefs.nmv$active), margin=1) # row-wise ## ## 0 1 2 ## 0 0.4574377 0.4531384 0.0894239 ## 1 0.4218362 0.4665012 0.1116625 nhefs.nmv$active=as.factor(nhefs.nmv$active) nhefs.nmv%&gt;%ggplot(aes(x = qsmk, fill = active)) + geom_bar(position = &quot;dodge&quot;) "]]
